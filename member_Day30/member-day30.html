<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 30 â€” TotWise Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/member_Day1/member.css">
    <script src="/auth/auth.js"></script>
    <!-- Reassurance Nudges -->
    <script src="/reassurance-nudges.js"></script>
    <!-- Soft Day-Locking -->
    <script src="/soft-day-lock.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="brand">
                <svg class="brand-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="14" fill="#E8B4A0"/>
                    <circle cx="11" cy="13" r="2.5" fill="#2D3B3A"/>
                    <circle cx="21" cy="13" r="2.5" fill="#2D3B3A"/>
                    <path d="M11 21 Q16 26 21 21" stroke="#2D3B3A" stroke-width="2" stroke-linecap="round" fill="none"/>
                </svg>
                <div class="brand-text">
                    <span class="brand-name">TotWise Lab</span>
                    <span class="toolkit-label">2â€“3 Years Toolkit</span>
                </div>
            </div>
            <button class="logout-btn">Log out</button>
        </header>

        <main class="content">
            <section class="day-header-card">
                <div class="day-info">
                    <div class="info-item">
                        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        <span>As little or as much as you like</span>
                    </div>
                    <div class="info-item">
                        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2a4 4 0 0 1 4 4c0 1.5-.8 2.8-2 3.5V11h-4V9.5A4 4 0 0 1 12 2z"/>
                            <path d="M8 14h8M9 18h6M10 22h4"/>
                        </svg>
                        <span>Trust & Carry-Forward</span>
                    </div>
                    <div class="info-item materials">
                        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                        <span>None</span>
                    </div>
                </div>
            </section>

            <section class="activity-card">
                <div class="card-header">
                    <span class="card-emoji">ðŸ§¸</span>
                    <h2>Today's Moment: "Pause & Notice"</h2>
                </div>

                <div class="activity-section">
                    <h3>
                        <svg class="section-icon" viewBox="0 0 20 20" fill="currentColor">
                            <circle cx="10" cy="10" r="8" fill="#A8C5A0" opacity="0.2"/>
                            <path d="M10 6v8M6 10h8" stroke="#A8C5A0" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        How to Use
                    </h3>
                    <ul class="step-list">
                        <li>Sit with your child</li>
                        <li>Notice what they're doing</li>
                        <li>Notice how you respond</li>
                        <li>No task. No activity.</li>
                    </ul>
                </div>

                <div class="activity-section what-to-say">
                    <h3>
                        <svg class="section-icon" viewBox="0 0 20 20" fill="currentColor">
                            <circle cx="10" cy="10" r="8" fill="#F5D5C8" opacity="0.3"/>
                            <path d="M7 8h6M7 12h4" stroke="#D9A592" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        What You Say
                    </h3>
                    <div class="speech-bubbles">
                        <div class="speech-bubble">
                            <span>"I see you."</span>
                        </div>
                        <div class="speech-bubble">
                            <span>"I'm here."</span>
                        </div>
                        <div class="speech-bubble">
                            <span>"That was fun."</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="worksheet-card">
                <div class="card-header small">
                    <span class="card-emoji">ðŸ–¨</span>
                    <h3>Optional Worksheet</h3>
                </div>
                <p class="worksheet-desc">Gentle reflection. Optional writing or drawing.</p>
                <p class="gentle-note">
                    <svg viewBox="0 0 20 20" fill="none">
                        <circle cx="10" cy="10" r="8" stroke="#A8C5A0" stroke-width="1.5"/>
                        <path d="M10 7v3M10 13h.01" stroke="#A8C5A0" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    If your child isn't interested today, you can skip this.
                </p>
                <a href="/member_Day30/day30-worksheet.html" target="_blank" class="worksheet-link">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M4 16v1a2 2 0 002 2h8a2 2 0 002-2v-1M12 11l-2 2-2-2M10 3v10"/>
                    </svg>
                    Download Worksheet
                </a>
            </section>

            <section class="script-card">
                <div class="card-header small">
                    <span class="card-emoji">ðŸ’¬</span>
                    <h3>Reflection</h3>
                </div>
                
                <div class="situation">
                    <p class="situation-text" style="font-style: italic; color: #5A6B6A;">You may have noticed:</p>
                </div>

                <div style="padding: 20px 0;">
                    <ul class="step-list" style="list-style: none; padding-left: 0;">
                        <li style="padding: 12px 0; border-bottom: 1px solid #F0F7EF;">More waiting</li>
                        <li style="padding: 12px 0; border-bottom: 1px solid #F0F7EF;">More trying</li>
                        <li style="padding: 12px 0; border-bottom: 1px solid #F0F7EF;">More connection</li>
                        <li style="padding: 12px 0;">More calm</li>
                    </ul>
                </div>

                <div class="situation" style="margin-top: 20px;">
                    <p class="situation-text" style="font-style: italic; color: #5A6B6A;">You don't need to remember every day.</p>
                    <p class="situation-text" style="font-style: italic; color: #5A6B6A; margin-top: 8px;">What mattered was showing up calmly.</p>
                </div>
            </section>

            <section class="emotional-card">
                <div class="card-header small">
                    <span class="card-emoji">ðŸ’›</span>
                    <h3>Parent Note</h3>
                </div>
                
                <div class="emotional-content">
                    <div class="emotional-text" style="text-align: center;">
                        <p style="font-size: 16px; line-height: 1.8; color: #2D3B3A;">Your child didn't need perfection.</p>
                        <p style="margin-top: 12px; font-size: 16px; line-height: 1.8; color: #2D3B3A;">They needed you â€” and you were there.</p>
                    </div>
                </div>
            </section>

            <section class="reassurance-strip">
                <div class="reassurance-icon">
                    <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 4 L18 12 L26 14 L18 16 L16 24 L14 16 L6 14 L14 12 Z" fill="#A8C5A0"/>
                        <circle cx="16" cy="14" r="3" fill="white"/>
                    </svg>
                </div>
                <div class="reassurance-text">
                    <p class="reassurance-title">This doesn't end here.</p>
                    <p class="reassurance-skills">This continues in everyday life.</p>
                </div>
            </section>

            <section class="completion-section">
                <button class="complete-btn" id="completeBtn">
                    <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M5 13l4 4L19 7"/>
                    </svg>
                    <span id="completeBtnText">Mark Today as Complete</span>
                </button>
            </section>
        </main>

        <div class="completion-overlay" id="completionOverlay">
            <div class="completion-modal">
                <div class="completion-celebration">
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" fill="#A8C5A0"/>
                        <path d="M30 50l12 12 28-28" stroke="white" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h2>Thank you for showing up for your child.</h2>
                <p>You did something wonderful.</p>
                <p class="completion-next">You've completed all 30 days.</p>
                <button class="modal-close-btn" id="closeModalBtn">Done</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            if (typeof TotWiseAuth === 'undefined') {
                const token = sessionStorage.getItem('loginToken');
                if (!token) {
                    const protocol = window.location.protocol;
                    const pathname = window.location.pathname;
                    if (protocol === 'http:' || protocol === 'https:') {
                        const basePath = pathname.split('/member_Day')[0];
                        window.location.href = basePath + '/login/login.html';
                    } else {
                        window.location.href = '../login/login.html';
                    }
                    return;
                }
            } else {
                TotWiseAuth.initAuth({ checkURLToken: false, requireAuth: true });
            }
        })();

        function getCurrentDay() {
            const pathname = window.location.pathname;
            const match = pathname.match(/member-day(\d+)\.html/);
            return match ? parseInt(match[1]) : 30;
        }

        const currentDay = getCurrentDay();

        // Check and apply soft day-locking if needed
        if (typeof TotWiseSoftLock !== 'undefined') {
            TotWiseSoftLock.checkAndApply(currentDay);
        }

        const completeBtn = document.getElementById('completeBtn');
        const completionOverlay = document.getElementById('completionOverlay');
        const closeModalBtn = document.getElementById('closeModalBtn');

        completeBtn.addEventListener('click', function() {
            // HARD GUARD: Prevent completion if day is not today (MUST BE FIRST CHECK)
            if (typeof TotWiseSoftLock !== 'undefined') {
                const currentUnlockedDay = TotWiseSoftLock.getCurrentUnlockedDay();
                if (currentDay !== currentUnlockedDay) {
                    // Block completion - show popup and return early
                    TotWiseSoftLock.showCompletionBlockedPopup(currentDay);
                    return false; // STOP execution - no progress update, no unlock, no nudge
                }
            }
            
            this.classList.add('completed');
            this.innerHTML = `<svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg><span>Completed</span>`;
            setTimeout(() => { completionOverlay.classList.add('show'); }, 300);
        });

        function handleCompletion() {
            // HARD GUARD: Prevent completion if day is not today (MUST BE FIRST CHECK)
            if (typeof TotWiseSoftLock !== 'undefined') {
                const currentUnlockedDay = TotWiseSoftLock.getCurrentUnlockedDay();
                if (currentDay !== currentUnlockedDay) {
                    // Block completion - show popup and return early
                    TotWiseSoftLock.showCompletionBlockedPopup(currentDay);
                    return false; // STOP execution - no progress update, no unlock, no nudge
                }
            }
            
            completionOverlay.classList.remove('show');
            const completedDays = JSON.parse(localStorage.getItem('totwise.progress.completedDays') || '[]');
            if (!completedDays.includes(currentDay)) {
                completedDays.push(currentDay);
                localStorage.setItem('totwise.progress.completedDays', JSON.stringify(completedDays));
            }
            
            // Check and show reassurance nudge if needed (only for unlocked days)
            const protocol = window.location.protocol;
            const pathname = window.location.pathname;
            
            function redirectToDashboard() {
                if (protocol === 'http:' || protocol === 'https:') {
                    const basePath = pathname.split('/member_Day')[0];
                    window.location.href = basePath + '/Dashboard/dashboard.html';
                } else {
                    window.location.href = '../Dashboard/dashboard.html';
                }
            }
            
            // Check for nudge (Day 7, 15, or 30) - only if day is not locked
            if (typeof TotWiseNudges !== 'undefined') {
                TotWiseNudges.checkAndShow(currentDay, redirectToDashboard);
            } else {
                redirectToDashboard();
            }
        }

        closeModalBtn.addEventListener('click', handleCompletion);
        completionOverlay.addEventListener('click', function(e) {
            if (e.target === completionOverlay) handleCompletion();
        });

        const logoutBtn = document.querySelector('.logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                if (typeof TotWiseAuth !== 'undefined') {
                    TotWiseAuth.logout();
                } else {
                    sessionStorage.removeItem('loginToken');
                    sessionStorage.removeItem('userEmail');
                    const protocol = window.location.protocol;
                    const pathname = window.location.pathname;
                    if (protocol === 'http:' || protocol === 'https:') {
                        const basePath = pathname.split('/member_Day')[0];
                        window.location.href = basePath + '/login/login.html';
                    } else {
                        window.location.href = '../login/login.html';
                    }
                }
            });
        }
    </script>
</body>
</html>
