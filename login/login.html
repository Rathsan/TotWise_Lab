<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login â€” TotWise Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="login.css">
</head>
<body>
    <div class="login-container">
        <!-- Background decoration -->
        <div class="bg-decoration">
            <div class="bg-circle bg-circle-1"></div>
            <div class="bg-circle bg-circle-2"></div>
            <div class="bg-circle bg-circle-3"></div>
        </div>

        <!-- Brand Header -->
        <header class="login-header">
            <div class="brand">
                <svg class="brand-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" fill="#E8B4A0"/>
                    <circle cx="14" cy="16" r="3" fill="#2D3B3A"/>
                    <circle cx="26" cy="16" r="3" fill="#2D3B3A"/>
                    <path d="M14 26 Q20 32 26 26" stroke="#2D3B3A" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                    <circle cx="8" cy="20" r="4" fill="#F5D5C8"/>
                    <circle cx="32" cy="20" r="4" fill="#F5D5C8"/>
                </svg>
                <span class="brand-name">TotWise Lab</span>
            </div>
            <p class="brand-subtitle">Parent Toolkit Access</p>
        </header>

        <!-- Main Login Card -->
        <main class="login-main">
            <div class="login-card" id="loginCard">
                <!-- Login Form State -->
                <div class="card-state login-form-state" id="formState">
                    <div class="welcome-icon">
                        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="24" cy="24" r="22" fill="#E8F5E8"/>
                            <path d="M24 12 C24 12 18 16 18 22 C18 26 20 30 24 34 C28 30 30 26 30 22 C30 16 24 12 24 12" fill="#A8C5A0"/>
                            <ellipse cx="24" cy="22" rx="4" ry="5" fill="#7BA876"/>
                        </svg>
                    </div>
                    
                    <h1>Welcome back <span class="emoji">ðŸŒ±</span></h1>
                    <p class="welcome-text">Enter your email and weâ€™ll take care of the rest.</p>

                    <form class="login-form" id="loginForm">
                        <div class="input-group">
                            <label for="email" class="visually-hidden">Email address</label>
                            <div class="input-wrapper">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="2" y="4" width="20" height="16" rx="3"/>
                                    <path d="M2 7l10 7 10-7"/>
                                </svg>
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email" 
                                    placeholder="your@email.com"
                                    autocomplete="email"
                                    required
                                >
                            </div>
                        </div>

                        <button type="submit" class="submit-btn">
                            <span>Continue</span>
                            <svg class="btn-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </form>
                    <p class="login-message" id="loginMessage"></p>
                    <p class="login-helper">No passwords. Secure link sent only if needed.</p>

                    <div class="reassurance">
                        <div class="reassurance-item">
                            <svg viewBox="0 0 20 20" fill="none">
                                <circle cx="10" cy="10" r="8" fill="#A8C5A0" opacity="0.2"/>
                                <path d="M7 10l2 2 4-4" stroke="#7BA876" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>No passwords needed</span>
                        </div>
                        <div class="reassurance-item">
                            <svg viewBox="0 0 20 20" fill="none">
                                <circle cx="10" cy="10" r="8" fill="#A8C5A0" opacity="0.2"/>
                                <path d="M7 10l2 2 4-4" stroke="#7BA876" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Your link is private and secure</span>
                        </div>
                        <div class="reassurance-item">
                            <svg viewBox="0 0 20 20" fill="none">
                                <circle cx="10" cy="10" r="8" fill="#A8C5A0" opacity="0.2"/>
                                <path d="M7 10l2 2 4-4" stroke="#7BA876" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>No spam, ever</span>
                        </div>
                    </div>
                </div>

                <!-- Success State -->
                <div class="card-state success-state" id="successState">
                    <div class="success-icon">
                        <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="40" cy="40" r="38" fill="#F0F7EF"/>
                            <circle cx="40" cy="40" r="28" fill="#A8C5A0"/>
                            <!-- Envelope -->
                            <rect x="24" y="30" width="32" height="22" rx="3" fill="white"/>
                            <path d="M24 33l16 10 16-10" stroke="#A8C5A0" stroke-width="2"/>
                            <!-- Sparkles -->
                            <circle cx="18" cy="24" r="3" fill="#E8B4A0"/>
                            <circle cx="62" cy="22" r="2" fill="#F5D5C8"/>
                            <circle cx="58" cy="58" r="2.5" fill="#E8B4A0"/>
                        </svg>
                    </div>
                    
                    <h2>Check your email <span class="emoji">ðŸ“©</span></h2>
                    <p class="success-text">Check your email â€” your secure login link is on its way ðŸ’›</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="login-footer">
            <p>Need help? <a href="mailto:hello@totwiselab.com">Contact us</a></p>
        </footer>
    </div>

    <!-- EmailJS SDK (legacy; not used by secure auth flow) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <script>
        const API_BASE = window.TOTWISE_API_BASE || '';
        const loginForm = document.getElementById('loginForm');
        const loginCard = document.getElementById('loginCard');
        const formState = document.getElementById('formState');
        const successState = document.getElementById('successState');
        const loginMessage = document.getElementById('loginMessage');

        function showSuccess() {
            formState.classList.add('hidden');
            successState.classList.add('visible');
            loginCard.classList.add('success');
        }

        function showForm() {
            formState.classList.remove('hidden');
            successState.classList.remove('visible');
            loginCard.classList.remove('success');
        }

        function getDashboardPath() {
            const protocol = window.location.protocol;
            const pathname = window.location.pathname;
            if (protocol === 'http:' || protocol === 'https:') {
                const basePath = pathname.split('/login')[0];
                return basePath + '/Dashboard/dashboard.html';
            }
            return '../Dashboard/dashboard.html';
        }

        async function loginWithEmail(email) {
            const response = await fetch(`${API_BASE}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ email })
            });

            if (!response.ok) {
                return { status: 'error' };
            }
            return response.json();
        }

        async function verifyMagicLink(token, email) {
            const response = await fetch(`${API_BASE}/api/auth/verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ token, email })
            });

            if (!response.ok) {
                throw new Error('Unable to sign in');
            }
        }

        async function handleMagicLink() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const email = params.get('email');
            if (!token || !email) return;

            try {
                await verifyMagicLink(token, email);
                window.location.href = getDashboardPath();
            } catch (error) {
                window.location.href = window.location.pathname;
            }
        }

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim();

            if (!email) {
                loginMessage.textContent = 'Please enter a valid email address.';
                return;
            }

            const submitBtn = this.querySelector('.submit-btn');
            const originalContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>Checking...</span>';
            submitBtn.disabled = true;
            loginMessage.textContent = 'Weâ€™re checking your access now.';

            try {
                const result = await loginWithEmail(email);
                if (result.status === 'logged_in') {
                    window.location.href = getDashboardPath();
                    return;
                }
                if (result.status === 'no_access') {
                    loginMessage.textContent = 'We couldnâ€™t find active access for this email.';
                    submitBtn.innerHTML = originalContent;
                    submitBtn.disabled = false;
                    return;
                }
                showSuccess();
            } catch (error) {
                loginMessage.textContent = 'Please try again in a moment.';
                submitBtn.innerHTML = originalContent;
                submitBtn.disabled = false;
            }
        });

        handleMagicLink();
    </script>
</body>
</html>
