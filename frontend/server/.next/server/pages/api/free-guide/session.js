"use strict";(()=>{var e={};e.id=950,e.ids=[950],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1309:e=>{e.exports=import("@supabase/supabase-js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8017:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>d,default:()=>c,routeModule:()=>l});var n=r(1802),s=r(7153),i=r(6249),u=r(1472),o=e([u]);u=(o.then?(await o)():o)[0];let c=(0,i.l)(u,"default"),d=(0,i.l)(u,"config"),l=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/free-guide/session",pathname:"/api/free-guide/session",bundlePath:"",filename:""},userland:u});a()}catch(e){a(e)}})},6075:(e,t,r)=>{r.d(t,{g:()=>i,M:()=>u});let a=require("postmark"),n=process.env.POSTMARK_SERVER_TOKEN,s=process.env.POSTMARK_SENDER_EMAIL;if(!n||!s)throw Error("Missing Postmark configuration");let i=new a.ServerClient(n),u=s},8901:(e,t,r)=>{r.d(t,{Rf:()=>l,YW:()=>f,Uj:()=>d,B3:()=>o,Jg:()=>c});let a=require("jsonwebtoken");var n=r.n(a);let s=require("cookie"),i="totwise_session",u=process.env.SESSION_SECRET;if(!u)throw Error("Missing SESSION_SECRET");function o(e){return n().sign(e,u,{expiresIn:3888e3})}function c(e){return n().verify(e,u)}function d(e,t){let r=(0,s.serialize)(i,t,{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:3888e3});e.setHeader("Set-Cookie",r)}function l(e){let t=(0,s.serialize)(i,"",{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,expires:new Date(0)});e.setHeader("Set-Cookie",t)}function f(e){if(e.cookies&&e.cookies[i])return e.cookies[i];let t=(e.headers.cookie||"").match(RegExp(`${i}=([^;]+)`));return t?t[1]:null}},4536:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{CX:()=>u,oY:()=>o,wW:()=>c});var n=r(2365),s=r(770),i=e([n]);async function u(e){let{data:t,error:r}=await n.p.from("users").select("*").eq("email",e).maybeSingle();if(r)throw r;return t}async function o(e){let t=await u(e);if(t)return t;let{data:r,error:a}=await n.p.from("users").insert({email:e}).select("*").single();if(a)throw a;return r}async function c(e){let{data:t,error:r}=await n.p.from("subscriptions").select("*").eq("user_id",e).eq("status","ACTIVE").eq("plan",s.eX).gt("expiry_date",new Date().toISOString()).order("expiry_date",{ascending:!1}).limit(1).maybeSingle();if(r)throw r;return t||null}n=(i.then?(await i)():i)[0],a()}catch(e){a(e)}})},2365:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{p:()=>o});var n=r(1309),s=e([n]);n=(s.then?(await s)():s)[0];let i=process.env.SUPABASE_URL,u=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!i||!u)throw Error("Missing Supabase admin credentials");let o=(0,n.createClient)(i,u,{auth:{persistSession:!1,autoRefreshToken:!1}});a()}catch(e){a(e)}})},770:(e,t,r)=>{r.d(t,{EB:()=>s,eX:()=>a,vV:()=>u,ws:()=>n,xd:()=>i});let a="age_2_3",n=199,s=19900,i=45;function u(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e).toLowerCase())}},1472:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>d});var n=r(8901),s=r(4536),i=r(2365),u=r(6075),o=e([s,i]);async function c(e,t,r){let a=`${r}/free-guide`,n=`Day ${t} of your free guide is ready`,s=`<p>Your Day ${t} guide is ready.</p><p><a href="${a}">Open your guide</a></p>`,i=`Your Day ${t} guide is ready: ${a}`;await u.g.sendEmail({From:u.M,To:e,Subject:n,HtmlBody:s,TextBody:i})}async function d(e,t){if("GET"!==e.method)return t.setHeader("Allow","GET"),t.status(405).json({error:"Method not allowed"});let r=(0,n.YW)(e);if(!r)return t.status(401).json({status:"unauthenticated"});try{let e=(0,n.Jg)(r);if(await (0,s.wW)(e.userId))return t.status(200).json({status:"paid"});let{data:a}=await i.p.from("free_guide_users").select("*").eq("user_id",e.userId).maybeSingle();if(!a)return t.status(200).json({status:"no_access"});let u=function(e){if(!e)return 0;let t=new Date(e).getTime(),r=Date.now();return Math.floor((r-t)/864e5)}(a.signup_date),o=Math.min(3,Math.max(1,u+1));if(o>(a.current_day||1)){await i.p.from("free_guide_users").update({current_day:o}).eq("user_id",e.userId);let t=process.env.APP_BASE_URL;t&&(o>=2&&2>(a.current_day||1)&&await c(e.email,2,t),o>=3&&3>(a.current_day||1)&&await c(e.email,3,t))}let d={...a,current_day:o};return t.status(200).json({status:"free",data:d})}catch(e){return t.status(401).json({status:"unauthenticated"})}}[s,i]=o.then?(await o)():o,a()}catch(e){a(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=8017);module.exports=r})();