"use strict";(()=>{var e={};e.id=908,e.ids=[908],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},1309:e=>{e.exports=import("@supabase/supabase-js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},1686:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.r(t),i.d(t,{config:()=>c,default:()=>u,routeModule:()=>d});var r=i(1802),s=i(7153),o=i(6249),a=i(5406),l=e([a]);a=(l.then?(await l)():l)[0];let u=(0,o.l)(a,"default"),c=(0,o.l)(a,"config"),d=new r.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/auth/login",pathname:"/api/auth/login",bundlePath:"",filename:""},userland:a});n()}catch(e){n(e)}})},6075:(e,t,i)=>{i.d(t,{g:()=>o,M:()=>a});let n=require("postmark"),r=process.env.POSTMARK_SERVER_TOKEN,s=process.env.POSTMARK_SENDER_EMAIL;if(!r||!s)throw Error("Missing Postmark configuration");let o=new n.ServerClient(r),a=s},8901:(e,t,i)=>{i.d(t,{Rf:()=>d,YW:()=>p,Uj:()=>c,B3:()=>l,Jg:()=>u});let n=require("jsonwebtoken");var r=i.n(n);let s=require("cookie"),o="totwise_session",a=process.env.SESSION_SECRET;if(!a)throw Error("Missing SESSION_SECRET");function l(e){return r().sign(e,a,{expiresIn:3888e3})}function u(e){return r().verify(e,a)}function c(e,t){let i=(0,s.serialize)(o,t,{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:3888e3});e.setHeader("Set-Cookie",i)}function d(e){let t=(0,s.serialize)(o,"",{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,expires:new Date(0)});e.setHeader("Set-Cookie",t)}function p(e){if(e.cookies&&e.cookies[o])return e.cookies[o];let t=(e.headers.cookie||"").match(RegExp(`${o}=([^;]+)`));return t?t[1]:null}},4536:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.d(t,{CX:()=>a,oY:()=>l,wW:()=>u});var r=i(2365),s=i(770),o=e([r]);async function a(e){let{data:t,error:i}=await r.p.from("users").select("*").eq("email",e).maybeSingle();if(i)throw i;return t}async function l(e){let t=await a(e);if(t)return t;let{data:i,error:n}=await r.p.from("users").insert({email:e}).select("*").single();if(n)throw n;return i}async function u(e){let{data:t,error:i}=await r.p.from("subscriptions").select("*").eq("user_id",e).eq("status","ACTIVE").eq("plan",s.eX).gt("expiry_date",new Date().toISOString()).order("expiry_date",{ascending:!1}).limit(1).maybeSingle();if(i)throw i;return t||null}r=(o.then?(await o)():o)[0],n()}catch(e){n(e)}})},2365:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.d(t,{p:()=>l});var r=i(1309),s=e([r]);r=(s.then?(await s)():s)[0];let o=process.env.SUPABASE_URL,a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!o||!a)throw Error("Missing Supabase admin credentials");let l=(0,r.createClient)(o,a,{auth:{persistSession:!1,autoRefreshToken:!1}});n()}catch(e){n(e)}})},770:(e,t,i)=>{i.d(t,{EB:()=>s,eX:()=>n,vV:()=>a,ws:()=>r,xd:()=>o});let n="age_2_3",r=199,s=19900,o=45;function a(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e).toLowerCase())}},5406:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.r(t),i.d(t,{default:()=>p});var r=i(4770),s=i.n(r),o=i(8901),a=i(4536),l=i(770),u=i(2365),c=i(6075),d=e([a,u]);async function p(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method not allowed"});let{email:i}=e.body||{};if(!(0,l.vV)(i))return t.status(400).json({error:"Valid email is required"});let n=(0,o.YW)(e);if(n)try{let e=(0,o.Jg)(n);if(await (0,a.wW)(e.userId))return t.status(200).json({status:"logged_in"})}catch(e){}try{let e=await (0,a.CX)(i);if(!e||!await (0,a.wW)(e.id))return t.status(200).json({status:"no_access"});let n=new Date(Date.now()-36e5).toISOString(),{count:r,error:o}=await u.p.from("auth_tokens").select("token",{count:"exact",head:!0}).eq("user_id",e.id).gte("created_at",n);if(o&&console.error("[auth] rate limit check error",o),o||r&&r>=3)return t.status(200).json({status:"link_sent"});let l=s().randomBytes(32).toString("hex"),d=new Date(Date.now()+18e5),{error:p}=await u.p.from("auth_tokens").insert({token:l,user_id:e.id,expires_at:d.toISOString(),used:!1});if(p)return console.error("[auth] token insert error",p),t.status(500).json({error:"Unable to send login link"});let f=process.env.APP_BASE_URL;if(!f)return t.status(500).json({error:"Missing APP_BASE_URL"});let g=`${f}/login/login.html?token=${l}&email=${encodeURIComponent(i)}`,h=`
      <div style="background:#FFF8F5;padding:24px 0;font-family:'DM Sans',Arial,sans-serif;color:#2D3B3A;">
        <div style="max-width:560px;margin:0 auto;background:#FFFFFF;border-radius:20px;padding:28px;box-shadow:0 12px 30px rgba(45,59,58,0.12);">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:40px;height:40px;border-radius:50%;background:#E8B4A0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2D3B3A;">TW</div>
            <div style="font-family:'Nunito',Arial,sans-serif;font-weight:800;font-size:18px;">TotWise Lab</div>
          </div>
          <h1 style="font-family:'Nunito',Arial,sans-serif;font-size:22px;margin:0 0 12px;">Your secure login link</h1>
          <p style="margin:0 0 18px;line-height:1.6;color:#4A5857;">Use the button below to access your TotWise Lab dashboard.</p>
          <a href="${g}" style="display:inline-block;background:#A8C5A0;color:#FFFFFF;text-decoration:none;padding:12px 22px;border-radius:999px;font-family:'Nunito',Arial,sans-serif;font-weight:700;">Access Dashboard</a>
          <p style="margin:18px 0 0;line-height:1.6;color:#4A5857;font-size:14px;">This login link expires in 30 minutes and can only be used once. You can request a new link any time while your subscription is active.</p>
        </div>
        <div style="max-width:560px;margin:12px auto 0;text-align:center;color:#7A8A89;font-size:12px;">
          \xa9 2026 TotWise Lab. Tiny Steps. Wise Growth.
        </div>
      </div>
    `,y=`Use this link to access your TotWise Lab dashboard: ${g}

This login link expires in 30 minutes and can only be used once. You can request a new link any time while your subscription is active.`;return await c.g.sendEmail({From:c.M,To:i,Subject:"Your secure TotWise login link",HtmlBody:h,TextBody:y}),t.status(200).json({status:"link_sent"})}catch(e){return console.error("[auth] login error",e),t.status(500).json({error:"Unable to sign in"})}}[a,u]=d.then?(await d)():d,n()}catch(e){n(e)}})},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=1686);module.exports=i})();