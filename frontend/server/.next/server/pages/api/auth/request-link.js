"use strict";(()=>{var e={};e.id=223,e.ids=[223],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},1309:e=>{e.exports=import("@supabase/supabase-js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},5197:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{config:()=>d,default:()=>u,routeModule:()=>c});var n=i(1802),s=i(7153),o=i(6249),a=i(5355),l=e([a]);a=(l.then?(await l)():l)[0];let u=(0,o.l)(a,"default"),d=(0,o.l)(a,"config"),c=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/auth/request-link",pathname:"/api/auth/request-link",bundlePath:"",filename:""},userland:a});r()}catch(e){r(e)}})},6075:(e,t,i)=>{i.d(t,{g:()=>o,M:()=>a});let r=require("postmark"),n=process.env.POSTMARK_SERVER_TOKEN,s=process.env.POSTMARK_SENDER_EMAIL;if(!n||!s)throw Error("Missing Postmark configuration");let o=new r.ServerClient(n),a=s},4536:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.d(t,{CX:()=>a,oY:()=>l,wW:()=>u});var n=i(2365),s=i(770),o=e([n]);async function a(e){let{data:t,error:i}=await n.p.from("users").select("*").eq("email",e).maybeSingle();if(i)throw i;return t}async function l(e){let t=await a(e);if(t)return t;let{data:i,error:r}=await n.p.from("users").insert({email:e}).select("*").single();if(r)throw r;return i}async function u(e){let{data:t,error:i}=await n.p.from("subscriptions").select("*").eq("user_id",e).eq("status","ACTIVE").eq("plan",s.eX).gt("expiry_date",new Date().toISOString()).order("expiry_date",{ascending:!1}).limit(1).maybeSingle();if(i)throw i;return t||null}n=(o.then?(await o)():o)[0],r()}catch(e){r(e)}})},2365:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.d(t,{p:()=>l});var n=i(1309),s=e([n]);n=(s.then?(await s)():s)[0];let o=process.env.SUPABASE_URL,a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!o||!a)throw Error("Missing Supabase admin credentials");let l=(0,n.createClient)(o,a,{auth:{persistSession:!1,autoRefreshToken:!1}});r()}catch(e){r(e)}})},770:(e,t,i)=>{i.d(t,{EB:()=>s,eX:()=>r,vV:()=>a,ws:()=>n,xd:()=>o});let r="age_2_3",n=199,s=19900,o=45;function a(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e).toLowerCase())}},5355:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{default:()=>c});var n=i(4770),s=i.n(n),o=i(6075),a=i(4536),l=i(770),u=i(2365),d=e([a,u]);async function c(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).json({error:"Method not allowed"});let{email:i}=e.body||{};if(!(0,l.vV)(i))return t.status(400).json({error:"Valid email is required"});try{let e=await (0,a.CX)(i);if(!e||!await (0,a.wW)(e.id))return t.status(403).json({error:"No active subscription"});let r=s().randomBytes(32).toString("hex"),n=new Date(Date.now()+18e5),{error:l}=await u.p.from("auth_tokens").insert({token:r,user_id:e.id,expires_at:n.toISOString(),used:!1});if(l)return console.error("[auth] token insert error",l),t.status(500).json({error:"Could not create login link"});let d=process.env.APP_BASE_URL;if(!d)return t.status(500).json({error:"Missing APP_BASE_URL"});let c=`${d}/login/login.html?token=${r}&email=${encodeURIComponent(i)}`,p=`
      <div style="background:#FFF8F5;padding:24px 0;font-family:'DM Sans',Arial,sans-serif;color:#2D3B3A;">
        <div style="max-width:560px;margin:0 auto;background:#FFFFFF;border-radius:20px;padding:28px;box-shadow:0 12px 30px rgba(45,59,58,0.12);">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:40px;height:40px;border-radius:50%;background:#E8B4A0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2D3B3A;">TW</div>
            <div style="font-family:'Nunito',Arial,sans-serif;font-weight:800;font-size:18px;">TotWise Lab</div>
          </div>
          <h1 style="font-family:'Nunito',Arial,sans-serif;font-size:22px;margin:0 0 12px;">Your secure login link</h1>
          <p style="margin:0 0 18px;line-height:1.6;color:#4A5857;">Use the button below to access your TotWise Lab dashboard.</p>
          <a href="${c}" style="display:inline-block;background:#A8C5A0;color:#FFFFFF;text-decoration:none;padding:12px 22px;border-radius:999px;font-family:'Nunito',Arial,sans-serif;font-weight:700;">Access Dashboard</a>
          <p style="margin:18px 0 0;line-height:1.6;color:#4A5857;font-size:14px;">This login link expires in 30 minutes and can only be used once. You can request a new link any time while your subscription is active.</p>
        </div>
        <div style="max-width:560px;margin:12px auto 0;text-align:center;color:#7A8A89;font-size:12px;">
          \xa9 2026 TotWise Lab. Tiny Steps. Wise Growth.
        </div>
      </div>
    `,f=`Use this link to access your TotWise Lab dashboard: ${c}

This login link expires in 30 minutes and can only be used once. You can request a new link any time while your subscription is active.`;return await o.g.sendEmail({From:o.M,To:i,Subject:"Your secure TotWise login link",HtmlBody:p,TextBody:f}),t.status(200).json({success:!0})}catch(e){return console.error("[auth] request-link error",e),t.status(500).json({error:"Unable to send login link"})}}[a,u]=d.then?(await d)():d,r()}catch(e){r(e)}})},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=5197);module.exports=i})();