"use strict";(()=>{var e={};e.id=186,e.ids=[186],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},1309:e=>{e.exports=import("@supabase/supabase-js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},6504:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{config:()=>d,default:()=>l,routeModule:()=>c});var i=n(1802),a=n(7153),s=n(6249),o=n(4487),u=e([o]);o=(u.then?(await u)():u)[0];let l=(0,s.l)(o,"default"),d=(0,s.l)(o,"config"),c=new i.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/webhooks/razorpay",pathname:"/api/webhooks/razorpay",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},6075:(e,t,n)=>{n.d(t,{g:()=>s,M:()=>o});let r=require("postmark"),i=process.env.POSTMARK_SERVER_TOKEN,a=process.env.POSTMARK_SENDER_EMAIL;if(!i||!a)throw Error("Missing Postmark configuration");let s=new r.ServerClient(i),o=a},4536:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.d(t,{CX:()=>o,oY:()=>u,wW:()=>l});var i=n(2365),a=n(770),s=e([i]);async function o(e){let{data:t,error:n}=await i.p.from("users").select("*").eq("email",e).maybeSingle();if(n)throw n;return t}async function u(e){let t=await o(e);if(t)return t;let{data:n,error:r}=await i.p.from("users").insert({email:e}).select("*").single();if(r)throw r;return n}async function l(e){let{data:t,error:n}=await i.p.from("subscriptions").select("*").eq("user_id",e).eq("status","ACTIVE").eq("plan",a.eX).gt("expiry_date",new Date().toISOString()).order("expiry_date",{ascending:!1}).limit(1).maybeSingle();if(n)throw n;return t||null}i=(s.then?(await s)():s)[0],r()}catch(e){r(e)}})},2365:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.d(t,{p:()=>u});var i=n(1309),a=e([i]);i=(a.then?(await a)():a)[0];let s=process.env.SUPABASE_URL,o=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!s||!o)throw Error("Missing Supabase admin credentials");let u=(0,i.createClient)(s,o,{auth:{persistSession:!1,autoRefreshToken:!1}});r()}catch(e){r(e)}})},770:(e,t,n)=>{n.d(t,{EB:()=>a,eX:()=>r,vV:()=>o,ws:()=>i,xd:()=>s});let r="age_2_3",i=199,a=19900,s=45;function o(e){return!!e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e).toLowerCase())}},4487:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{config:()=>p,default:()=>c});var i=n(4770),a=n.n(i),s=n(2365),o=n(4536),u=n(770),l=n(6075),d=e([s,o]);[s,o]=d.then?(await d)():d;let p={api:{bodyParser:!1}};async function c(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).end("Method not allowed");let n=await new Promise((t,n)=>{let r="";e.on("data",e=>{r+=e}),e.on("end",()=>t(r)),e.on("error",e=>n(e))}),r=e.headers["x-razorpay-signature"],i=process.env.RAZORPAY_WEBHOOK_SECRET;if(!r||!i)return t.status(400).end("Missing webhook signature");if(a().createHmac("sha256",i).update(n).digest("hex")!==r)return t.status(401).end("Invalid signature");let d=JSON.parse(n);if(console.log("[webhook] event received:",d.event),"payment.captured"!==d.event)return t.status(200).json({received:!0});let c=d.payload?.payment?.entity,p=c?.notes?.email||c?.email,f=c?.amount,h=c?.id;if(console.log("[webhook] payment captured:",{paymentId:h,amount:f,email:p}),!p||!h)return t.status(400).end("Missing payment data");if(f!==u.EB)return t.status(400).end("Amount mismatch");try{let e=await (0,o.oY)(p),n=new Date,r=new Date(n.getTime());r.setDate(r.getDate()+u.xd);let{error:i}=await s.p.from("subscriptions").insert({user_id:e.id,plan:u.eX,amount:u.ws,status:"ACTIVE",payment_id:h,start_date:n.toISOString(),expiry_date:r.toISOString()});if(i)return console.error("[webhook] subscription insert error",i),t.status(500).end("Subscription insert failed");let d=a().randomBytes(32).toString("hex"),c=new Date(Date.now()+18e5),{error:f}=await s.p.from("auth_tokens").insert({token:d,user_id:e.id,expires_at:c.toISOString(),used:!1});if(f)return console.error("[webhook] auth token insert error",f),t.status(500).end("Auth token insert failed");let m=process.env.APP_BASE_URL;if(!m)return t.status(500).end("Missing APP_BASE_URL");let y=`${m}/login/login.html?token=${d}&email=${encodeURIComponent(p)}`,g=`
      <div style="background:#FFF8F5;padding:24px 0;font-family:'DM Sans',Arial,sans-serif;color:#2D3B3A;">
        <div style="max-width:560px;margin:0 auto;background:#FFFFFF;border-radius:20px;padding:28px;box-shadow:0 12px 30px rgba(45,59,58,0.12);">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="width:40px;height:40px;border-radius:50%;background:#E8B4A0;display:flex;align-items:center;justify-content:center;font-weight:700;color:#2D3B3A;">TW</div>
            <div style="font-family:'Nunito',Arial,sans-serif;font-weight:800;font-size:18px;">TotWise Lab</div>
          </div>
          <h1 style="font-family:'Nunito',Arial,sans-serif;font-size:22px;margin:0 0 12px;">Payment successful.</h1>
          <p style="margin:0 0 18px;line-height:1.6;color:#4A5857;">Your subscription is active. Use the button below to access your dashboard.</p>
          <a href="${y}" style="display:inline-block;background:#A8C5A0;color:#FFFFFF;text-decoration:none;padding:12px 22px;border-radius:999px;font-family:'Nunito',Arial,sans-serif;font-weight:700;">Access your dashboard</a>
          <p style="margin:18px 0 0;line-height:1.6;color:#4A5857;font-size:14px;">This login link expires in 30 minutes and can only be used once. You can request a new link any time while your subscription is active.</p>
        </div>
        <div style="max-width:560px;margin:12px auto 0;text-align:center;color:#7A8A89;font-size:12px;">
          \xa9 2026 TotWise Lab. Tiny Steps. Wise Growth.
        </div>
      </div>
    `,w=`Payment successful.

Access your dashboard: ${y}

This login link expires in 30 minutes and can only be used once. You can request a new link any time while your subscription is active.`,x=await l.g.sendEmail({From:l.M,To:p,Subject:"Your secure TotWise login link",HtmlBody:g,TextBody:w});return console.log("[webhook] postmark response:",x),t.status(200).json({received:!0})}catch(e){return console.error("[webhook] error",e),t.status(500).end("Webhook error")}}r()}catch(e){r(e)}})},7153:(e,t)=>{var n;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,t,n)=>{e.exports=n(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=6504);module.exports=n})();